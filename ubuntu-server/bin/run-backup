#!/bin/sh

set -e

usage() {
  echo "Usage: $0 [--log[=PATH]] SOURCE DESTINATION"
  echo ""
  echo "Backup files using rsync with predefined exclusions"
  echo ""
  echo "Options:"
  echo "  --log[=PATH]  Log output to file (default: ~/rsync-backup.log)"
  echo ""
  echo "Arguments:"
  echo "  SOURCE        Directory to back up (required)"
  echo "  DESTINATION   Backup destination (required)"
  exit 1
}

LOG_FILE=""

while [ $# -gt 0 ]; do
  case "$1" in
    --log)
      LOG_FILE="/home/josephschmitt/rsync-backup.log"
      shift
      ;;
    --log=*)
      LOG_FILE="${1#*=}"
      shift
      ;;
    --help|-h)
      usage
      ;;
    *)
      if [ -z "$SOURCE" ]; then
        SOURCE="$1"
      elif [ -z "$DESTINATION" ]; then
        DESTINATION="$1"
      else
        echo "Error: Too many arguments"
        usage
      fi
      shift
      ;;
  esac
done

if [ -z "$SOURCE" ] || [ -z "$DESTINATION" ]; then
  echo "Error: SOURCE and DESTINATION are required"
  usage
fi

run_rsync() {
  if [ -n "$LOG_FILE" ]; then
    rsync -avz --delete \
      --exclude '*/.mono/keypairs/**' \
      --exclude '*/radarr/Backups/manual/**' \
      --exclude 'downloads/' \
      "$SOURCE" "$DESTINATION"
  else
    rsync -az --delete --info=progress2 \
      --exclude '*/.mono/keypairs/**' \
      --exclude '*/radarr/Backups/manual/**' \
      --exclude 'downloads/' \
      "$SOURCE" "$DESTINATION"
  fi
}

if [ -n "$LOG_FILE" ]; then
  run_rsync 2>&1 | tee -a "$LOG_FILE"
else
  run_rsync
fi
